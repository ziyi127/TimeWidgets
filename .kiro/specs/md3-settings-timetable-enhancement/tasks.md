# Implementation Plan

- [x] 1. Create MD3 utility classes for dialogs and forms
  - [x] 1.1 Create MD3DialogStyles utility class
    - Create `lib/utils/md3_dialog_styles.dart` with standard dialog, fullscreen dialog, and confirm dialog methods
    - Implement proper MD3 corner radius (28dp), surface tint, and spacing
    - _Requirements: 5.1, 5.3, 5.4, 5.5_
  - [x] 1.2 Create MD3FormStyles utility class
    - Create `lib/utils/md3_form_styles.dart` with outlined/filled text fields, dropdowns, time picker, color picker buttons
    - Implement proper MD3 input decoration and styling
    - _Requirements: 2.3, 3.3_
  - [x] 1.3 Write property test for icon button touch targets
    - **Property 8: Icon button touch target minimum size**
    - **Validates: Requirements 6.4**

- [x] 2. Extend data models for ClassIsland compatibility
  - [x] 2.1 Extend TimeSlot model with type and default subject
    - Add `TimePointType type`, `String? defaultSubjectId`, `bool isHiddenByDefault` fields
    - Update JSON serialization/deserialization
    - _Requirements: 10.2, 10.5_
  - [x] 2.2 Extend CourseInfo model with abbreviation and outdoor flag
    - Add `String abbreviation`, `bool isOutdoor` fields
    - Update JSON serialization/deserialization
    - _Requirements: 12.1_
  - [x] 2.3 Create Schedule and ScheduleTriggerRule models
    - Create models for schedule with trigger rules
    - Implement JSON serialization
    - _Requirements: 11.1, 11.3_
  - [x] 2.4 Write property test for serialization round-trip
    - **Property 7: Timetable data serialization round-trip**
    - **Validates: Requirements 15.1, 15.2**

- [x] 3. Checkpoint - Ensure all tests pass
  - All tests pass

- [x] 4. Implement schedule activation logic
  - [x] 4.1 Implement trigger rule matching logic
    - Add method to check if schedule matches current date/week type
    - _Requirements: 11.3_
  - [x] 4.2 Implement schedule priority ordering
    - Add priority field and sorting logic for multiple matching schedules
    - _Requirements: 11.4_
  - [x] 4.3 Write property test for schedule auto-activation
    - **Property 2: Schedule auto-activation based on trigger rules**
    - **Validates: Requirements 11.3**
  - [x] 4.4 Write property test for schedule priority ordering
    - **Property 3: Schedule priority ordering**
    - **Validates: Requirements 11.4**

- [x] 5. Implement subject management with deletion protection
  - [x] 5.1 Add subject usage tracking
    - Implement method to find all course assignments using a subject
    - _Requirements: 12.4_
  - [x] 5.2 Implement deletion prevention logic
    - Add check before deletion, return usage information if subject is in use
    - _Requirements: 12.4_
  - [x] 5.3 Write property test for subject deletion prevention
    - **Property 4: Subject deletion prevention when in use**
    - **Validates: Requirements 12.4**

- [x] 6. Implement color utilities
  - [x] 6.1 Implement deterministic color generation from name
    - Create utility function to generate consistent color from subject name hash
    - _Requirements: 14.3_
  - [x] 6.2 Implement color contrast calculation
    - Create utility to calculate contrast ratio and determine appropriate text color
    - _Requirements: 14.2_
  - [x] 6.3 Write property test for deterministic color generation
    - **Property 6: Deterministic color generation from name**
    - **Validates: Requirements 14.3**
  - [x] 6.4 Write property test for color contrast
    - **Property 5: Color contrast for text readability**
    - **Validates: Requirements 14.2**

- [x] 7. Checkpoint - Ensure all tests pass
  - All tests pass

- [x] 8. Refactor Settings Screen with MD3 styles
  - [x] 8.1 Update setting group cards to use MD3CardStyles
    - Already using MD3CardStyles.surfaceContainer
    - _Requirements: 1.1_
  - [x] 8.2 Update switches and toggles to MD3 styling
    - SwitchListTile uses proper MD3 color tokens
    - _Requirements: 1.2_
  - [x] 8.3 Update dropdowns to MD3 styling
    - Use MD3FormStyles.dropdown for all selection settings
    - _Requirements: 1.3_
  - [x] 8.4 Update dialogs to MD3 styling
    - Use MD3DialogStyles for reset confirmation dialog
    - _Requirements: 5.1, 5.5_

- [x] 9. Refactor TimetableEditScreen with three-tab structure
  - [x] 9.1 Restructure tabs to 课表/时间表/科目
    - Update TabController and TabBar with new tab structure
    - _Requirements: 9.1, 9.2_
  - [x] 9.2 Create MasterDetailLayout widget
    - Implemented master-detail layout in each tab
    - _Requirements: 9.3_
  - [x] 9.3 Implement empty state for unselected items
    - Show guidance message when no item is selected
    - _Requirements: 9.4, 7.1, 7.3_

- [x] 10. Implement SubjectEditTab (科目编辑)
  - [x] 10.1 Create subject list view with MD3 styling
    - Implement left panel with subject list using MD3CardStyles
    - Show color indicator for each subject
    - _Requirements: 12.2, 12.5, 14.4_
  - [x] 10.2 Create subject detail editor panel
    - Implement right panel with form fields for name, abbreviation, teacher, color
    - Use MD3FormStyles for all inputs
    - _Requirements: 12.1, 12.3_
  - [x] 10.3 Implement add/edit subject dialog
    - Use MD3DialogStyles for subject creation/editing
    - Include MD3 color picker
    - _Requirements: 14.1, 2.2, 2.4_
  - [x] 10.4 Implement subject deletion with usage check
    - Show warning dialog if subject is in use
    - _Requirements: 12.4, 5.5_

- [x] 11. Implement TimeLayoutEditTab (时间表编辑)
  - [x] 11.1 Create time layout list view
    - Implement left panel with time layout list
    - _Requirements: 10.1_
  - [x] 11.2 Create timeline editor component
    - Implement visual timeline showing time points in chronological order
    - Use MD3 colors to distinguish time point types
    - _Requirements: 10.1, 10.3_
  - [x] 11.3 Implement time point type selection
    - Add UI for selecting 上课/课间休息/分割线 types
    - _Requirements: 10.2_
  - [x] 11.4 Implement time point editing
    - Allow editing start/end times, name, and default subject
    - _Requirements: 10.5, 3.2_
  - [x] 11.5 Write property test for time points chronological ordering
    - **Property 1: Time points chronological ordering**
    - **Validates: Requirements 10.1**

- [x] 12. Implement ScheduleEditTab (课表编辑)
  - [x] 12.1 Create schedule list view with trigger rules
    - Implement left panel showing schedules with activation status
    - _Requirements: 11.5_
  - [x] 12.2 Create schedule grid editor
    - Implement grid with time slots as rows for assigning subjects
    - _Requirements: 11.2_
  - [x] 12.3 Implement trigger rule editor
    - Add UI for setting weekday and week type rules
    - _Requirements: 11.1_
  - [x] 12.4 Implement week type selection for assignments
    - Add 每周/单周/双周 selection when assigning subjects
    - Show week type badge for non-every-week assignments
    - _Requirements: 13.1, 13.2, 13.3_
  - [x] 12.5 Implement week type filtering
    - Add filter to view schedule for specific week types
    - _Requirements: 13.4_

- [x] 13. Checkpoint - Ensure all tests pass
  - All property tests pass

- [x] 14. Update import/export functionality
  - [x] 14.1 Update ClassIsland import to handle extended models
    - Parse additional fields from ClassIsland format (timeLayouts, schedules, TimePointType, etc.)
    - Added ClassIslandImportResult and ClassIslandImportStats classes
    - _Requirements: 15.1_
  - [x] 14.2 Update export to include extended model fields
    - Added ImportResult and ImportStats classes to TimetableExportService
    - Added validation for timeLayouts and schedules fields
    - _Requirements: 15.2_
  - [x] 14.3 Implement import error handling with MD3 styling
    - Added _showErrorSnackBar with MD3 error container styling
    - _Requirements: 15.3_
  - [x] 14.4 Implement import success feedback
    - Added _showSuccessSnackBar with MD3 primary container styling
    - Shows imported item counts via ImportStats.toString()
    - _Requirements: 15.4_

- [x] 15. Apply MD3 styling to remaining dialogs
  - [x] 15.1 Update course add/edit dialog
    - SubjectEditTab uses MD3DialogStyles.dialog and MD3FormStyles throughout
    - _Requirements: 2.2, 2.4_
  - [x] 15.2 Update time slot add/edit dialog
    - TimeLayoutEditTab uses MD3DialogStyles.dialog and MD3FormStyles
    - _Requirements: 3.4, 3.5_
  - [x] 15.3 Update delete confirmation dialogs
    - All tabs use MD3DialogStyles.showDeleteConfirmDialog with error styling
    - _Requirements: 5.5_

- [x] 16. Final polish and consistency check
  - [x] 16.1 Ensure all buttons follow MD3 hierarchy
    - Filled for primary actions (save, add), FilledTonal for secondary, Text for cancel
    - _Requirements: 2.4, 2.5, 3.4, 3.5_
  - [x] 16.2 Ensure all empty states have guidance
    - All tabs have empty states with FilledTonal buttons to guide users
    - _Requirements: 7.1, 7.3_
  - [x] 16.3 Verify ripple effects and touch targets
    - All interactive elements use MD3ButtonStyles with proper feedback
    - _Requirements: 6.1, 6.4_

- [x] 17. Final Checkpoint - Ensure all tests pass
  - Core property tests pass (timetable serialization, schedule activation, subject deletion, color utils, time points ordering)
  - Note: Some pre-existing test files have encoding issues that need separate attention
