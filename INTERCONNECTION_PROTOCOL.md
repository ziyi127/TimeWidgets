# 设备互联协议文档 (Experimental)

本文档描述了 TimeWidgets 应用中“设备互联”功能的通信协议与工作流程。该功能旨在局域网环境下，实现主设备（Master）向从设备（Slave）单向同步设置和课表数据。

> **⚠️ 安全警告**：本协议目前使用明文传输，未加密且无身份验证。请仅在可信的局域网环境中使用。开启此功能可能会导致隐私数据（如课表、设置）在局域网内泄露。

## 1. 概述

设备互联采用 **主从架构 (Master-Slave)**：
*   **主设备 (Master)**：主动扫描局域网内的从设备，发起连接，并将本机的数据（设置、课表）推送给从设备。主设备拥有控制权。
*   **从设备 (Slave)**：启动后在局域网内发送 UDP 广播告知自身存在，并监听 TCP 端口等待主设备连接。接收到数据后自动应用。从设备处于被动接收状态。

## 2. 发现与配对 (Discovery & Pairing)

### 2.1 首次发现 (UDP Broadcast)

*   **协议**: UDP Broadcast
*   **端口**: 8899
*   **广播频率**: 每 2 秒一次 (仅从设备发送)
*   **广播内容**: JSON 字符串 (UTF-8)

> **注意**：从设备的 UDP 广播主要用于首次被主设备发现。一旦主设备完成首次连接并配对，后续连接将直接使用保存的 IP 地址。

#### 广播数据包格式

```json
{
  "name": "快乐的苹果",  // 设备名称
  "port": 8900,         // TCP 同步服务监听端口
  "type": "slave",      // 设备类型标识
  "authToken": "..."    // (新增) 身份认证令牌，用于IP漂移恢复
}
```

*   **Master 行为**: 监听 UDP 8899 端口，收集局域网内所有广播的设备信息，展示在列表中供用户选择。
*   **Slave 行为**: 向 `255.255.255.255:8899` 发送上述 JSON 数据包。

### 2.2 配对与持久化

*   当用户在 Master 设备上选择一个新设备并成功连接后，该设备即被标记为 **已配对 (Paired)**。
*   Master 设备会将已配对设备的 IP、端口、名称以及 **authToken** 信息持久化保存到本地存储。
*   **自动重连**: 每次 Master 设备启动或用户手动触发时，Master 会尝试自动遍历所有已配对设备，直接发起 TCP 连接进行同步。

### 2.3 IP 漂移恢复 (IP Recovery via Auth Token)

为了解决局域网内 IP 租期短导致从设备 IP 变更的问题，引入了基于 Auth Token 的恢复机制：

1.  **连接失败检测**: 当 Master 尝试连接已配对设备的 IP 失败时，会触发恢复流程。
2.  **认证恢复广播**: Master 向 UDP 8901 端口发送广播，包含目标设备的 `authToken`。
    ```json
    {
      "type": "auth_recovery",
      "authToken": "...",
      "targetName": "快乐的苹果"
    }
    ```
3.  **从设备响应**: 从设备监听 UDP 8901 端口。若收到的 `authToken` 与本机匹配，则立即触发一次标准的 Presence Broadcast (发送到 UDP 8899)。
4.  **IP 更新**: Master 收到 Presence Broadcast 后，检测到该 `authToken` 对应已配对设备但 IP 已变更，自动更新本地配对列表中的 IP 地址，并重新发起连接。

## 3. 同步机制 (Synchronization)

*   **协议**: TCP
*   **默认端口**: 8900 (可由广播包中的 `port` 字段指定)
*   **连接方向**: Master -> Slave

### 同步流程

1.  **配对连接**: 用户选择新设备 -> Master 保存配对信息 -> 发起同步。
2.  **自动重连**: Master 启动 -> 读取配对列表 -> 逐个发起同步。
3.  **手动同步**: 用户在已配对列表点击同步 -> 发起同步。

### 同步数据包格式

Master 发送的数据为 JSON 字符串 (UTF-8)：

```json
{
  "type": "sync",
  "settings": {
    // AppSettings 模型的 JSON 序列化数据
    "themeSettings": { ... },
    "apiBaseUrl": "...",
    "enableNotifications": true,
    ...
  },
  "timetable": {
    // TimetableData 模型的 JSON 序列化数据
    "courses": [ ... ],
    "timeSlots": [ ... ],
    ...
  }
}
```

### 字段说明

*   `type`: 必须为 `"sync"`。
*   `settings`: 包含应用全局设置信息。
*   `timetable`: 包含课程表、时间表结构及单日课程调整信息。

## 4. 安全与注意事项

1.  **无加密**: 所有数据（包括可能包含的个人信息）均通过明文 JSON 传输。
2.  **无认证**: 任何知晓协议的设备均可向从设备发送数据，或伪装成从设备接收主设备数据。
3.  **局域网限制**: 设计仅用于受信任的家庭或校园局域网环境。
4.  **数据覆盖**: 从设备接收到数据后，会**强制覆盖**本地原有的设置和课表，此操作不可逆。

## 5. 开发指南

### 接入步骤

1.  **监听广播**: 在 UDP 8899 端口监听，解析 JSON 获取 IP 和 Port。
2.  **建立连接**: 使用 TCP 连接目标 IP 和 Port。
3.  **发送数据**: 构造符合上述格式的 JSON 数据并写入 Socket。
4.  **断开连接**: 发送完成后关闭 Socket。

### 示例代码 (Dart)

见 `lib/services/interconnection_service.dart` 中的 `InterconnectionService` 类。
